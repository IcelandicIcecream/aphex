---
title: Storage
description: The StorageAdapter interface, local filesystem and S3-compatible storage, asset uploads, and image metadata.
---

Aphex uses a pluggable storage system for file uploads. If no storage adapter is configured, files are stored on the **local filesystem** by default. For production, use the S3-compatible adapter.

## StorageAdapter interface

```ts
interface StorageAdapter {
  readonly name: string;

  // Core operations (required)
  store(data: UploadFileData): Promise<StorageFile>;
  delete(path: string): Promise<boolean>;
  exists(path: string): Promise<boolean>;
  getUrl(path: string): string;

  // Info and health
  getStorageInfo(): Promise<{ totalSize: number; availableSpace?: number }>;
  isHealthy(): Promise<boolean>;

  // Connection lifecycle (optional)
  connect?(): Promise<void>;
  disconnect?(): Promise<void>;

  // Extended operations (optional)
  getObject?(path: string): Promise<Buffer>;
  listObjects?(options?: ListObjectsOptions): Promise<ListObjectsResult>;
  copyObject?(sourcePath: string, destPath: string): Promise<boolean>;
  getObjectMetadata?(path: string): Promise<StorageObjectMetadata>;
  getSignedUrl?(path: string, expiresIn?: number): Promise<string>;
}
```

The `name` property identifies which adapter stored each file, allowing safe migrations between storage backends.

## Local filesystem (default)

When no `storage` option is set in your config, Aphex creates a local filesystem adapter automatically:

- **Storage path:** `./storage/assets`
- **Serving path:** `/media/{assetId}/{filename}`
- **Max file size:** 10 MB
- **Allowed types:** JPEG, PNG, WebP, GIF, AVIF, PDF, plain text

```ts title="aphex.config.ts"
export default createCMSConfig({
  // No storage option — local filesystem is used
  schemaTypes,
  database: db,
});
```

For local storage, files are served through the CMS's asset CDN route (`/media/[id]/[filename]`), which handles access control and caching. Assets get a 1-year `Cache-Control` header since URLs are content-addressed.

## S3-compatible storage

For production deployments, use the S3 adapter. It works with any S3-compatible service.

### Installation

```bash
pnpm add @aphexcms/storage-s3
```

### Configuration

Use the `s3Storage()` helper:

```ts title="src/lib/server/storage/index.ts"
import { s3Storage } from '@aphexcms/storage-s3';
import { env } from '$env/dynamic/private';

export const storage = s3Storage({
  bucket: env.R2_BUCKET,
  endpoint: env.R2_ENDPOINT,
  accessKeyId: env.R2_ACCESS_KEY_ID,
  secretAccessKey: env.R2_SECRET_ACCESS_KEY,
  publicUrl: env.R2_PUBLIC_URL
});
```

Then pass it to your config:

```ts title="aphex.config.ts"
import { storage } from '$lib/server/storage/index.js';

export default createCMSConfig({
  storage,
  // ...
});
```

The `s3Storage()` helper returns `{ adapter, disableLocalStorage: true }` — telling the CMS to skip the default local adapter.

### Options

| Option | Type | Required | Default | Description |
|--------|------|----------|---------|-------------|
| `bucket` | `string` | Yes | — | S3 bucket name |
| `endpoint` | `string` | Yes | — | S3 endpoint URL |
| `accessKeyId` | `string` | Yes | — | API access key ID |
| `secretAccessKey` | `string` | Yes | — | API secret access key |
| `region` | `string` | No | `'auto'` | AWS region |
| `publicUrl` | `string` | No | Same as endpoint | Public URL for serving files |
| `basePath` | `string` | No | `''` | Path prefix for organizing files |
| `maxFileSize` | `number` | No | `10485760` (10 MB) | Maximum upload size in bytes |
| `allowedTypes` | `string[]` | No | Common image types | Allowed MIME types |

### Provider examples

**Cloudflare R2:**

```ts
s3Storage({
  bucket: env.R2_BUCKET,
  endpoint: env.R2_ENDPOINT,
  accessKeyId: env.R2_ACCESS_KEY_ID,
  secretAccessKey: env.R2_SECRET_ACCESS_KEY,
  publicUrl: env.R2_PUBLIC_URL
})
```

**AWS S3:**

```ts
s3Storage({
  bucket: 'my-bucket',
  endpoint: 'https://s3.us-east-1.amazonaws.com',
  accessKeyId: env.AWS_ACCESS_KEY_ID,
  secretAccessKey: env.AWS_SECRET_ACCESS_KEY,
  region: 'us-east-1'
})
```

**MinIO (local development):**

```ts
s3Storage({
  bucket: 'my-bucket',
  endpoint: 'http://localhost:9000',
  accessKeyId: 'minioadmin',
  secretAccessKey: 'minioadmin'
})
```

## Upload flow

When a file is uploaded via the admin UI or `POST /api/assets`:

1. **Validation** — MIME type and file size are checked against the adapter's limits.
2. **Image metadata extraction** — for images, [Sharp](https://sharp.pixelplumbing.com/) extracts width, height, format, color space, dominant color, and more.
3. **Storage** — the file is stored via the adapter. S3 adapters generate unique filenames with timestamp and random suffix.
4. **Database record** — an asset record is saved with file metadata, storage path, and the adapter name.
5. **URL generation** — for local storage, a clean CDN URL (`/media/{assetId}/{filename}`) is set. For S3, the public URL from the adapter is used.

If the database save fails, the file is automatically deleted from storage (rollback).

## Image metadata

For image uploads, the `AssetService` extracts metadata using Sharp:

| Field | Description |
|-------|-------------|
| `width` | Width in pixels |
| `height` | Height in pixels |
| `format` | Image format (jpeg, png, webp, etc.) |
| `space` | Color space (srgb, rgb, etc.) |
| `channels` | Number of color channels |
| `density` | DPI if available |
| `hasProfile` | Whether an ICC color profile is embedded |
| `hasAlpha` | Whether the image has transparency |
| `dominantColor` | Dominant RGB color |

This metadata is stored in the asset's `metadata` JSONB column and is available through the API.

## Asset access control

Assets served through the CDN route (`/media/[id]/[filename]`) go through access control:

1. **Public assets** — served without authentication.
2. **Private assets** — fields marked `private: true` in your schema require an authenticated session.
3. **Organization isolation** — assets respect the same multi-tenant rules as documents. Parent organizations can access child organization assets.

For S3 storage, assets with external public URLs bypass the CDN route and are served directly from the S3 endpoint.

## Asset tracking

Each asset record stores which `storageAdapter` was used (e.g. `'local'` or `'s3'`). This enables:

- **Safe migrations** — move from local to S3 without breaking existing assets.
- **Adapter mismatch warnings** — if you delete an asset stored by a different adapter, the system logs a warning.
- **Mixed storage** — older assets on local storage continue to work after switching to S3.

## Custom adapters

To implement a custom storage adapter:

```ts
import type { StorageAdapter } from '@aphexcms/cms-core/server';

class MyStorageAdapter implements StorageAdapter {
  readonly name = 'my-storage';

  async store(data) {
    // Upload file, return { path, url, size }
  }

  async delete(path) {
    // Delete file, return true/false
  }

  async exists(path) {
    // Check if file exists
  }

  getUrl(path) {
    // Return public URL for path
  }

  async getStorageInfo() {
    return { totalSize: 0 };
  }

  async isHealthy() {
    // Return true if storage is reachable
  }
}
```

The required methods are `store`, `delete`, `exists`, `getUrl`, `getStorageInfo`, and `isHealthy`. The extended methods (`getObject`, `listObjects`, `copyObject`, `getObjectMetadata`, `getSignedUrl`) are optional and enable additional features like file serving from local storage and admin file browsing.
