var ne=Object.defineProperty,se=Object.defineProperties,oe=Object.getOwnPropertyDescriptors,H=Object.getOwnPropertySymbols,ie=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable,J=(e,t,r)=>t in e?ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,_=(e,t)=>{for(var r in t||(t={}))ie.call(t,r)&&J(e,r,t[r]);if(H)for(var r of H(t))ae.call(t,r)&&J(e,r,t[r]);return e},w=(e,t)=>se(e,oe(t)),ue=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r}},ce=async(e,t)=>{var r,n,s,c,a,d;let l=t||{};const o={onRequest:[t?.onRequest],onResponse:[t?.onResponse],onSuccess:[t?.onSuccess],onError:[t?.onError],onRetry:[t?.onRetry]};if(!t||!t?.plugins)return{url:e,options:l,hooks:o};for(const i of t?.plugins||[]){if(i.init){const f=await((r=i.init)==null?void 0:r.call(i,e.toString(),t));l=f.options||l,e=f.url}o.onRequest.push((n=i.hooks)==null?void 0:n.onRequest),o.onResponse.push((s=i.hooks)==null?void 0:s.onResponse),o.onSuccess.push((c=i.hooks)==null?void 0:c.onSuccess),o.onError.push((a=i.hooks)==null?void 0:a.onError),o.onRetry.push((d=i.hooks)==null?void 0:d.onRetry)}return{url:e,options:l,hooks:o}},V=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},le=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}};function fe(e){if(typeof e=="number")return new V({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new V(e);case"exponential":return new le(e);default:throw new Error("Invalid retry strategy")}}var de=async e=>{const t={},r=async n=>typeof n=="function"?await n():n;if(e?.auth){if(e.auth.type==="Bearer"){const n=await r(e.auth.token);if(!n)return t;t.authorization=`Bearer ${n}`}else if(e.auth.type==="Basic"){const n=r(e.auth.username),s=r(e.auth.password);if(!n||!s)return t;t.authorization=`Basic ${btoa(`${n}:${s}`)}`}else if(e.auth.type==="Custom"){const n=r(e.auth.value);if(!n)return t;t.authorization=`${r(e.auth.prefix)} ${n}`}}return t},he=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function pe(e){const t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";const n=t.split(";").shift()||"";return he.test(n)?"json":r.has(n)||n.startsWith("text/")?"text":"blob"}function ye(e){try{return JSON.parse(e),!0}catch{return!1}}function Y(e){if(e===void 0)return!1;const t=typeof e;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function G(e){try{return JSON.parse(e)}catch{return e}}function Q(e){return typeof e=="function"}function ge(e){if(e?.customFetchImpl)return e.customFetchImpl;if(typeof globalThis<"u"&&Q(globalThis.fetch))return globalThis.fetch;if(typeof window<"u"&&Q(window.fetch))return window.fetch;throw new Error("No fetch implementation found")}async function me(e){const t=new Headers(e?.headers),r=await de(e);for(const[n,s]of Object.entries(r||{}))t.set(n,s);if(!t.has("content-type")){const n=ve(e?.body);n&&t.set("content-type",n)}return t}function ve(e){return Y(e)?"application/json":null}function _e(e){if(!e?.body)return null;const t=new Headers(e?.headers);if(Y(e.body)&&!t.has("content-type")){for(const[r,n]of Object.entries(e?.body))n instanceof Date&&(e.body[r]=n.toISOString());return JSON.stringify(e.body)}return e.body}function we(e,t){var r;if(t?.method)return t.method.toUpperCase();if(e.startsWith("@")){const n=(r=e.split("@")[1])==null?void 0:r.split("/")[0];return Z.includes(n)?n.toUpperCase():t?.body?"POST":"GET"}return t?.body?"POST":"GET"}function be(e,t){let r;return!e?.signal&&e?.timeout&&(r=setTimeout(()=>t?.abort(),e?.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}var Re=class z extends Error{constructor(t,r){super(r||JSON.stringify(t,null,2)),this.issues=t,Object.setPrototypeOf(this,z.prototype)}};async function C(e,t){let r=await e["~standard"].validate(t);if(r.issues)throw new Re(r.issues);return r.value}var Z=["get","post","put","patch","delete"],Te=e=>({id:"apply-schema",name:"Apply Schema",version:"1.0.0",async init(t,r){var n,s,c,a;const d=((s=(n=e.plugins)==null?void 0:n.find(l=>{var o;return(o=l.schema)!=null&&o.config?t.startsWith(l.schema.config.baseURL||"")||t.startsWith(l.schema.config.prefix||""):!1}))==null?void 0:s.schema)||e.schema;if(d){let l=t;(c=d.config)!=null&&c.prefix&&l.startsWith(d.config.prefix)&&(l=l.replace(d.config.prefix,""),d.config.baseURL&&(t=t.replace(d.config.prefix,d.config.baseURL))),(a=d.config)!=null&&a.baseURL&&l.startsWith(d.config.baseURL)&&(l=l.replace(d.config.baseURL,""));const o=d.schema[l];if(o){let i=w(_({},r),{method:o.method,output:o.output});return r?.disableValidation||(i=w(_({},i),{body:o.input?await C(o.input,r?.body):r?.body,params:o.params?await C(o.params,r?.params):r?.params,query:o.query?await C(o.query,r?.query):r?.query})),{url:t,options:i}}}return{url:t,options:r}}}),Se=e=>{async function t(r,n){const s=w(_(_({},e),n),{plugins:[...e?.plugins||[],Te(e||{})]});if(e?.catchAllError)try{return await B(r,s)}catch(c){return{data:null,error:{status:500,statusText:"Fetch Error",message:"Fetch related error. Captured by catchAllError option. See error property for more details.",error:c}}}return await B(r,s)}return t};function Oe(e,t){let{baseURL:r,params:n,query:s}=t||{query:{},params:{},baseURL:""},c=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r||"";if(e.startsWith("@")){const f=e.toString().split("@")[1].split("/")[0];Z.includes(f)&&(e=e.replace(`@${f}/`,"/"))}c.endsWith("/")||(c+="/");let[a,d]=e.replace(c,"").split("?");const l=new URLSearchParams(d);for(const[f,h]of Object.entries(s||{}))h!=null&&l.set(f,String(h));if(n)if(Array.isArray(n)){const f=a.split("/").filter(h=>h.startsWith(":"));for(const[h,b]of f.entries()){const R=n[h];a=a.replace(b,R)}}else for(const[f,h]of Object.entries(n))a=a.replace(`:${f}`,String(h));a=a.split("/").map(encodeURIComponent).join("/"),a.startsWith("/")&&(a=a.slice(1));let o=l.toString();return o=o.length>0?`?${o}`.replace(/\+/g,"%20"):"",c.startsWith("http")?new URL(`${a}${o}`,c):`${c}${a}${o}`}var B=async(e,t)=>{var r,n,s,c,a,d,l,o;const{hooks:i,url:f,options:h}=await ce(e,t),b=ge(h),R=new AbortController,L=(r=h.signal)!=null?r:R.signal,g=Oe(f,h),U=_e(h),P=await me(h),T=we(f,h);let u=w(_({},h),{url:g,headers:P,body:U,method:T,signal:L});for(const m of i.onRequest)if(m){const y=await m(u);y instanceof Object&&(u=y)}("pipeTo"in u&&typeof u.pipeTo=="function"||typeof((n=t?.body)==null?void 0:n.pipe)=="function")&&("duplex"in u||(u.duplex="half"));const{clearTimeout:I}=be(h,R);let p=await b(u.url,u);I();const M={response:p,request:u};for(const m of i.onResponse)if(m){const y=await m(w(_({},M),{response:(s=t?.hookOptions)!=null&&s.cloneResponse?p.clone():p}));y instanceof Response?p=y:y instanceof Object&&(p=y.response)}if(p.ok){if(!(u.method!=="HEAD"))return{data:"",error:null};const y=pe(p),S={data:"",response:p,request:u};if(y==="json"||y==="text"){const O=await p.text(),re=await((c=u.jsonParser)!=null?c:G)(O);S.data=re}else S.data=await p[y]();u?.output&&u.output&&!u.disableValidation&&(S.data=await C(u.output,S.data));for(const O of i.onSuccess)O&&await O(w(_({},S),{response:(a=t?.hookOptions)!=null&&a.cloneResponse?p.clone():p}));return t?.throw?S.data:{data:S.data,error:null}}const ee=(d=t?.jsonParser)!=null?d:G,N=await p.text(),W=ye(N),$=W?await ee(N):null,te={response:p,responseText:N,request:u,error:w(_({},$),{status:p.status,statusText:p.statusText})};for(const m of i.onError)m&&await m(w(_({},te),{response:(l=t?.hookOptions)!=null&&l.cloneResponse?p.clone():p}));if(t?.retry){const m=fe(t.retry),y=(o=t.retryAttempt)!=null?o:0;if(await m.shouldAttemptRetry(y,p)){for(const O of i.onRetry)O&&await O(M);const S=m.getDelay(y);return await new Promise(O=>setTimeout(O,S)),await B(e,w(_({},t),{retryAttempt:y+1}))}}if(t?.throw)throw new ue(p.status,p.statusText,W?$:N);return{data:null,error:w(_({},$),{status:p.status,statusText:p.statusText})}},Pe={};const F=Object.create(null),x=e=>Pe||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?F:globalThis),A=new Proxy(F,{get(e,t){return x()[t]??F[t]},has(e,t){const r=x();return t in r||t in F},set(e,t,r){const n=x(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;const r=x(!0);return delete r[t],!0},ownKeys(){const e=x(!0);return Object.keys(e)}});class Ee extends Error{constructor(t,r){super(t),this.name="BetterAuthError",this.message=t,this.cause=r,this.stack=""}}function Ue(e){try{return new URL(e).pathname!=="/"}catch{throw new Ee(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function D(e,t="/api/auth"){return Ue(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e.replace(/\/+$/,"")}${t}`)}function Ae(e,t,r,n){if(e)return D(e,t);{const s=A.BETTER_AUTH_URL||A.NEXT_PUBLIC_BETTER_AUTH_URL||A.PUBLIC_BETTER_AUTH_URL||A.NUXT_PUBLIC_BETTER_AUTH_URL||A.NUXT_PUBLIC_AUTH_URL||(A.BASE_URL!=="/"?A.BASE_URL:void 0);if(s)return D(s,t)}if(typeof window<"u"&&window.location)return D(window.location.origin,t)}let v=[],E=0;const q=4;let K=e=>{let t=[],r={get(){return r.lc||r.listen(()=>{})(),r.value},lc:0,listen(n){return r.lc=t.push(n),()=>{for(let c=E+q;c<v.length;)v[c]===n?v.splice(c,q):c+=q;let s=t.indexOf(n);~s&&(t.splice(s,1),--r.lc||r.off())}},notify(n,s){let c=!v.length;for(let a of t)v.push(a,r.value,n,s);if(c){for(E=0;E<v.length;E+=q)v[E](v[E+1],v[E+2],v[E+3]);v.length=0}},off(){},set(n){let s=r.value;s!==n&&(r.value=n,r.notify(s))},subscribe(n){let s=r.listen(n);return n(r.value),s},value:e};return r};const Le=5,k=6,j=10;let Ie=(e,t,r,n)=>(e.events=e.events||{},e.events[r+j]||(e.events[r+j]=n(s=>{e.events[r].reduceRight((c,a)=>(a(c),c),{shared:{},...s})})),e.events[r]=e.events[r]||[],e.events[r].push(t),()=>{let s=e.events[r],c=s.indexOf(t);s.splice(c,1),s.length||(delete e.events[r],e.events[r+j](),delete e.events[r+j])}),xe=1e3,Ne=(e,t)=>Ie(e,n=>{let s=t(n);s&&e.events[k].push(s)},Le,n=>{let s=e.listen;e.listen=(...a)=>(!e.lc&&!e.active&&(e.active=!0,n()),s(...a));let c=e.off;return e.events[k]=[],e.off=()=>{c(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let a of e.events[k])a();e.events[k]=[]}},xe)},()=>{e.listen=s,e.off=c}});const qe=typeof window>"u",ke=(e,t,r,n)=>{const s=K({data:null,error:null,isPending:!0,isRefetching:!1,refetch:d=>c(d)}),c=d=>{const l=typeof n=="function"?n({data:s.get().data,error:s.get().error,isPending:s.get().isPending}):n;r(t,{...l,query:{...l?.query,...d?.query},async onSuccess(o){s.set({data:o.data,error:null,isPending:!1,isRefetching:!1,refetch:s.value.refetch}),await l?.onSuccess?.(o)},async onError(o){const{request:i}=o,f=typeof i.retry=="number"?i.retry:i.retry?.attempts,h=i.retryAttempt||0;f&&h<f||(s.set({error:o.error,data:null,isPending:!1,isRefetching:!1,refetch:s.value.refetch}),await l?.onError?.(o))},async onRequest(o){const i=s.get();s.set({isPending:i.data===null,data:i.data,error:null,isRefetching:!0,refetch:s.value.refetch}),await l?.onRequest?.(o)}}).catch(o=>{s.set({error:o,data:null,isPending:!1,isRefetching:!1,refetch:s.value.refetch})})};e=Array.isArray(e)?e:[e];let a=!1;for(const d of e)d.subscribe(()=>{qe||(a?c():Ne(s,()=>{const l=setTimeout(()=>{a||(c(),a=!0)},0);return()=>{s.off(),d.off(),clearTimeout(l)}}))});return s},je={proto:/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,constructor:/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,protoShort:/"__proto__"\s*:/,constructorShort:/"constructor"\s*:/},Ce=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/,X={true:!0,false:!1,null:null,undefined:void 0,nan:Number.NaN,infinity:Number.POSITIVE_INFINITY,"-infinity":Number.NEGATIVE_INFINITY},Fe=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,7}))?(?:Z|([+-])(\d{2}):(\d{2}))$/;function $e(e){return e instanceof Date&&!isNaN(e.getTime())}function De(e){const t=Fe.exec(e);if(!t)return null;const[,r,n,s,c,a,d,l,o,i,f]=t;let h=new Date(Date.UTC(parseInt(r,10),parseInt(n,10)-1,parseInt(s,10),parseInt(c,10),parseInt(a,10),parseInt(d,10),l?parseInt(l.padEnd(3,"0"),10):0));if(o){const b=(parseInt(i,10)*60+parseInt(f,10))*(o==="+"?-1:1);h.setUTCMinutes(h.getUTCMinutes()+b)}return $e(h)?h:null}function Be(e,t={}){const{strict:r=!1,warnings:n=!1,reviver:s,parseDates:c=!0}=t;if(typeof e!="string")return e;const a=e.trim();if(a.length>0&&a[0]==='"'&&a.endsWith('"')&&!a.slice(1,-1).includes('"'))return a.slice(1,-1);const d=a.toLowerCase();if(d.length<=9&&d in X)return X[d];if(!Ce.test(a)){if(r)throw new SyntaxError("[better-json] Invalid JSON");return e}if(Object.entries(je).some(([o,i])=>{const f=i.test(a);return f&&n&&console.warn(`[better-json] Detected potential prototype pollution attempt using ${o} pattern`),f})&&r)throw new Error("[better-json] Potential prototype pollution attempt detected");try{return JSON.parse(a,(i,f)=>{if(i==="__proto__"||i==="constructor"&&f&&typeof f=="object"&&"prototype"in f){n&&console.warn(`[better-json] Dropping "${i}" key to prevent prototype pollution`);return}if(c&&typeof f=="string"){const h=De(f);if(h)return h}return s?s(i,f):f})}catch(o){if(r)throw o;return e}}function Me(e,t={strict:!0}){return Be(e,t)}const We={id:"redirect",name:"Redirect",hooks:{onSuccess(e){if(e.data?.url&&e.data?.redirect&&typeof window<"u"&&window.location&&window.location)try{window.location.href=e.data.url}catch{}}}};function He(e){const t=K(!1);return{session:ke(t,"/get-session",e,{method:"GET"}),$sessionSignal:t}}const Je=(e,t)=>{const r="credentials"in Request.prototype,n=Ae(e?.baseURL,e?.basePath)??"/api/auth",s=e?.plugins?.flatMap(u=>u.fetchPlugins).filter(u=>u!==void 0)||[],c={id:"lifecycle-hooks",name:"lifecycle-hooks",hooks:{onSuccess:e?.fetchOptions?.onSuccess,onError:e?.fetchOptions?.onError,onRequest:e?.fetchOptions?.onRequest,onResponse:e?.fetchOptions?.onResponse}},{onSuccess:a,onError:d,onRequest:l,onResponse:o,...i}=e?.fetchOptions||{},f=Se({baseURL:n,...r?{credentials:"include"}:{},method:"GET",jsonParser(u){return u?Me(u,{strict:!1}):null},customFetchImpl:fetch,...i,plugins:[c,...i.plugins||[],...e?.disableDefaultFetchPlugins?[]:[We],...s]}),{$sessionSignal:h,session:b}=He(f),R=e?.plugins||[];let L={},g={$sessionSignal:h,session:b},U={"/sign-out":"POST","/revoke-sessions":"POST","/revoke-other-sessions":"POST","/delete-user":"POST"};const P=[{signal:"$sessionSignal",matcher(u){return u==="/sign-out"||u==="/update-user"||u.startsWith("/sign-in")||u.startsWith("/sign-up")||u==="/delete-user"||u==="/verify-email"}}];for(const u of R)u.getAtoms&&Object.assign(g,u.getAtoms?.(f)),u.pathMethods&&Object.assign(U,u.pathMethods),u.atomListeners&&P.push(...u.atomListeners);const T={notify:u=>{g[u].set(!g[u].get())},listen:(u,I)=>{g[u].subscribe(I)},atoms:g};for(const u of R)u.getActions&&Object.assign(L,u.getActions?.(f,T,e));return{get baseURL(){return n},pluginsActions:L,pluginsAtoms:g,pluginPathMethods:U,atomListeners:P,$fetch:f,$store:T}};function Ve(e){return typeof e=="object"&&e!==null&&"get"in e&&typeof e.get=="function"&&"lc"in e&&typeof e.lc=="number"}function Ge(e,t,r){const n=t[e],{fetchOptions:s,query:c,...a}=r||{};return n||(s?.method?s.method:a&&Object.keys(a).length>0?"POST":"GET")}function Qe(e,t,r,n,s){function c(a=[]){return new Proxy(function(){},{get(d,l){if(l==="then"||l==="catch"||l==="finally")return;const o=[...a,l];let i=e;for(const f of o)if(i&&typeof i=="object"&&f in i)i=i[f];else{i=void 0;break}return typeof i=="function"||Ve(i)?i:c(o)},apply:async(d,l,o)=>{const i="/"+a.map(P=>P.replace(/[A-Z]/g,T=>`-${T.toLowerCase()}`)).join("/"),f=o[0]||{},h=o[1]||{},{query:b,fetchOptions:R,...L}=f,g={...h,...R},U=Ge(i,r,f);return await t(i,{...g,body:U==="GET"?void 0:{...L,...g?.body||{}},query:b||g?.query,method:U,async onSuccess(P){await g?.onSuccess?.(P);const T=s?.find(p=>p.matcher(i));if(!T)return;const u=n[T.signal];if(!u)return;const I=u.get();setTimeout(()=>{u.set(!I)},10)}})}})}return c()}function Xe(e){return e.charAt(0).toUpperCase()+e.slice(1)}function Ye(e){const{pluginPathMethods:t,pluginsActions:r,pluginsAtoms:n,$fetch:s,atomListeners:c,$store:a}=Je(e);let d={};for(const[i,f]of Object.entries(n))d[`use${Xe(i)}`]=()=>f;const l={...r,...d,$fetch:s,$store:a};return Qe(l,s,t,n,c)}const ze=()=>({id:"api-key",$InferServerPlugin:{},pathMethods:{"/api-key/create":"POST","/api-key/delete":"POST","/api-key/delete-all-expired-api-keys":"POST"}}),Ze=Ye({plugins:[ze()]}),{signIn:et,signUp:tt,signOut:rt,useSession:nt,apiKey:st}=Ze;export{Ze as a};
