{"version":3,"file":"6-B8jxMFnx.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/(protected)/admin/settings/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/6.js"],"sourcesContent":["import { d as drizzleDb, u as user, a as apikey } from \"../../../../../chunks/index3.js\";\nimport { organizations, invitations, organizationMembers } from \"@aphexcms/postgresql-adapter/schema\";\nimport { eq } from \"drizzle-orm\";\nconst organizationService = {\n  /**\n   * Get organization with enriched member data (includes user details)\n   * This performs a join between CMS organizationMembers and auth user tables\n   */\n  async getOrganizationWithMembers(organizationId) {\n    const org = await drizzleDb.query.organizations.findFirst({\n      where: eq(organizations.id, organizationId)\n    });\n    if (!org) {\n      return null;\n    }\n    const members = await drizzleDb.select({\n      member: organizationMembers,\n      user: {\n        id: user.id,\n        email: user.email,\n        name: user.name,\n        image: user.image\n      },\n      invitation: {\n        email: invitations.email\n      }\n    }).from(organizationMembers).innerJoin(user, eq(organizationMembers.userId, user.id)).leftJoin(invitations, eq(organizationMembers.invitationId, invitations.id)).where(eq(organizationMembers.organizationId, organizationId));\n    return {\n      organization: org,\n      members: members.map((m) => ({\n        member: m.member,\n        user: {\n          id: m.user.id,\n          email: m.user.email,\n          name: m.user.name,\n          image: m.user.image\n        },\n        invitedEmail: m.invitation?.email || null\n      }))\n    };\n  }\n};\nconst load = async ({ locals }) => {\n  const auth = locals.auth;\n  if (!auth || auth.type !== \"session\") {\n    throw new Error(\"No session found\");\n  }\n  const userApiKeys = await drizzleDb.query.apikey.findMany({\n    where: eq(apikey.userId, auth.user.id),\n    columns: {\n      id: true,\n      name: true,\n      metadata: true,\n      expiresAt: true,\n      lastRequest: true,\n      createdAt: true\n    },\n    orderBy: (apikey2, { desc }) => [desc(apikey2.createdAt)]\n  });\n  const apiKeysWithPermissions = userApiKeys.map((key) => {\n    let metadata = key.metadata;\n    if (typeof metadata === \"string\") {\n      metadata = JSON.parse(metadata);\n      if (typeof metadata === \"string\") {\n        metadata = JSON.parse(metadata);\n      }\n    }\n    metadata = metadata || null;\n    return {\n      ...key,\n      permissions: metadata.permissions || [],\n      organizationId: metadata.organizationId\n    };\n  }).filter((key) => key.organizationId === auth.organizationId);\n  const databaseAdapter = locals.aphexCMS.databaseAdapter;\n  let activeOrganization = null;\n  let pendingInvitations = [];\n  let currentUserOrgRole = null;\n  if (auth.organizationId) {\n    const orgData = await organizationService.getOrganizationWithMembers(auth.organizationId);\n    if (orgData) {\n      activeOrganization = {\n        ...orgData.organization,\n        members: orgData.members.map((m) => ({\n          ...m.member,\n          user: m.user,\n          invitedEmail: m.invitedEmail\n        }))\n      };\n      const currentMember = orgData.members.find((m) => m.user.id === auth.user.id);\n      currentUserOrgRole = currentMember?.member.role || null;\n    }\n    const invitations2 = await databaseAdapter.findOrganizationInvitations(auth.organizationId);\n    pendingInvitations = invitations2.filter((inv) => !inv.acceptedAt && inv.expiresAt > /* @__PURE__ */ new Date());\n  }\n  return {\n    user: {\n      id: auth.user.id,\n      email: auth.user.email,\n      name: auth.user.name,\n      role: auth.user.role,\n      organizationRole: currentUserOrgRole\n      // Add organization role\n    },\n    apiKeys: apiKeysWithPermissions,\n    activeOrganization,\n    pendingInvitations\n  };\n};\nexport {\n  load\n};\n","import * as server from '../entries/pages/(protected)/admin/settings/_page.server.ts.js';\n\nexport const index = 6;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/(protected)/admin/settings/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/(protected)/admin/settings/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/6.Bln5tfKQ.js\",\"_app/immutable/chunks/DsnmJJEf.js\",\"_app/immutable/chunks/DWBROaph.js\",\"_app/immutable/chunks/D4agE4Ng.js\",\"_app/immutable/chunks/CQxSK_kJ.js\",\"_app/immutable/chunks/CrQaW3DA.js\",\"_app/immutable/chunks/CMwlA4jW.js\",\"_app/immutable/chunks/Da8QwHVz.js\",\"_app/immutable/chunks/zhm3sqsy.js\",\"_app/immutable/chunks/CI7EuJFJ.js\",\"_app/immutable/chunks/CC2su3ap.js\",\"_app/immutable/chunks/CgH_2WnA.js\",\"_app/immutable/chunks/D8BKmG1w.js\",\"_app/immutable/chunks/DL8tdTp6.js\",\"_app/immutable/chunks/CrOXdnIQ.js\",\"_app/immutable/chunks/AHJMyVxs.js\",\"_app/immutable/chunks/DJpeLsgd.js\"];\nexport const stylesheets = [\"_app/immutable/assets/6.CV-KWLNP.css\"];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}