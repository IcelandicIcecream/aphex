{"version":3,"file":"_server.ts-BoW_dP8a.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/media/_id_/_filename_/_server.ts.js"],"sourcesContent":["import \"@sveltejs/kit\";\nimport \"../../../../../chunks/storage.js\";\nimport \"sharp\";\nconst GET = async ({ params, locals, setHeaders, request }) => {\n  console.log(\"[Asset CDN] ========== ROUTE HIT ==========\");\n  console.log(\"[Asset CDN] Params:\", params);\n  try {\n    const { assetService, databaseAdapter, storageAdapter, cmsEngine, config } = locals.aphexCMS;\n    let auth = locals.auth;\n    const { id, filename } = params;\n    console.log(\"[Asset CDN] Request for asset:\", id, filename);\n    console.log(\"[Asset CDN] Has auth?\", !!auth);\n    if (!auth) {\n      const apiKey = request.headers.get(\"x-api-key\");\n      console.log(\"[Asset CDN] API key present?\", !!apiKey);\n      if (apiKey && config.auth?.provider) {\n        try {\n          const apiKeyAuth = await config.auth.provider.validateApiKey(request, databaseAdapter);\n          if (apiKeyAuth) {\n            auth = apiKeyAuth;\n            console.log(\"[Asset CDN] Authenticated via API key, org:\", apiKeyAuth.organizationId);\n          }\n        } catch (err) {\n          console.warn(\"[Asset CDN] API key validation failed:\", err);\n        }\n      }\n    }\n    console.log(\"[Asset CDN] Auth type:\", auth?.type);\n    if (!id) {\n      return new Response(\"Asset ID is required\", { status: 400 });\n    }\n    const asset = await assetService.findAssetByIdGlobal(id);\n    console.log(\"[Asset CDN] Asset found globally?\", !!asset);\n    if (!asset) {\n      console.warn(\"[Asset CDN] Asset not found:\", id);\n      return new Response(\"Asset not found\", { status: 404 });\n    }\n    const organizationId = auth?.organizationId;\n    console.log(\"[Asset CDN] Auth object:\", JSON.stringify(auth, null, 2));\n    console.log(\"[Asset CDN] Auth organizationId:\", organizationId);\n    console.log(\"[Asset CDN] Asset organizationId:\", asset.organizationId);\n    let isPrivate = false;\n    const schemaType = asset.metadata?.schemaType;\n    const fieldPath = asset.metadata?.fieldPath;\n    if (schemaType && fieldPath) {\n      const schema = cmsEngine.getSchemaTypeByName(schemaType);\n      console.log(`[Asset CDN] Schema lookup for ${schemaType}:`, {\n        found: !!schema,\n        fieldCount: schema?.fields?.length\n      });\n      if (schema && schema.fields) {\n        const findField = (fields, path) => {\n          const parts = path.split(\".\");\n          let current = null;\n          for (let i = 0; i < parts.length; i++) {\n            const part = parts[i];\n            current = fields.find((f) => f.name === part);\n            if (!current)\n              return null;\n            if (i < parts.length - 1) {\n              if (current.type === \"object\" && current.fields) {\n                fields = current.fields;\n              } else {\n                return null;\n              }\n            }\n          }\n          return current;\n        };\n        const field = findField(schema.fields, fieldPath);\n        console.log(`[Asset CDN] Field lookup for ${fieldPath}:`, {\n          found: !!field,\n          type: field?.type,\n          private: field?.private\n        });\n        if (field && field.type === \"image\") {\n          isPrivate = field.private === true;\n          console.log(`[Asset CDN] Field check: ${schemaType}.${fieldPath} - private: ${isPrivate}`);\n        } else {\n          console.warn(`[Asset CDN] Could not find field: ${schemaType}.${fieldPath}`);\n        }\n      }\n    } else {\n      console.log(\"[Asset CDN] No field metadata - treating as public\");\n    }\n    console.log(\"[Asset CDN] Asset privacy result:\", { isPrivate, schemaType, fieldPath });\n    if (isPrivate && !organizationId) {\n      console.warn(\"[Asset CDN] Private asset accessed without auth - DENIED\");\n      return new Response(\"Unauthorized - This asset is private\", { status: 401 });\n    }\n    if (isPrivate && organizationId && organizationId !== asset.organizationId) {\n      console.warn(\"[Asset CDN] Org mismatch for private asset - FORBIDDEN\");\n      return new Response(\"Forbidden\", { status: 403 });\n    }\n    if (isPrivate && organizationId) {\n      console.log(\"[Asset CDN] Private asset access ALLOWED - user has auth and org matches\");\n    } else if (!isPrivate) {\n      console.log(\"[Asset CDN] Public asset access ALLOWED\");\n    }\n    console.log(\"[Asset CDN] Asset found:\", {\n      id: asset.id,\n      path: asset.path,\n      mimeType: asset.mimeType,\n      storageAdapter: asset.storageAdapter\n    });\n    if (asset.url && asset.url.startsWith(\"http\")) {\n      console.log(\"[Asset CDN] Redirecting to external URL:\", asset.url);\n      return new Response(null, {\n        status: 302,\n        headers: { Location: asset.url }\n      });\n    }\n    if (!storageAdapter?.getObject) {\n      console.error(\"[Asset CDN] Storage adapter does not support getObject\");\n      return new Response(\"Storage adapter does not support file serving\", { status: 500 });\n    }\n    console.log(\"[Asset CDN] Reading file from storage:\", asset.path);\n    const fileBuffer = await storageAdapter.getObject(asset.path);\n    console.log(\"[Asset CDN] Serving file:\", {\n      size: fileBuffer.length,\n      mimeType: asset.mimeType\n    });\n    setHeaders({\n      \"Content-Type\": asset.mimeType || \"application/octet-stream\",\n      \"Content-Length\": fileBuffer.length.toString(),\n      \"Cache-Control\": \"public, max-age=31536000, immutable\",\n      // Cache for 1 year\n      \"Content-Disposition\": `inline; filename=\"${encodeURIComponent(asset.originalFilename || asset.filename)}\"`,\n      ...asset.mimeType?.startsWith(\"image/\") && {\n        \"Accept-Ranges\": \"bytes\"\n      }\n    });\n    const arrayBuffer = fileBuffer.buffer.slice(fileBuffer.byteOffset, fileBuffer.byteOffset + fileBuffer.byteLength);\n    return new Response(arrayBuffer);\n  } catch (error) {\n    console.error(\"[Asset CDN] Error serving asset:\", error);\n    return new Response(\"Failed to serve asset\", { status: 500 });\n  }\n};\nconsole.log(\"[Media Route] Module loaded at /media/[id]/[filename]\");\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}