{"version":3,"file":"instance2-stPrjck3.js","sources":["../../../.svelte-kit/adapter-node/chunks/instance2.js"],"sourcesContent":["import { betterAuth } from \"better-auth\";\nimport { apiKey } from \"better-auth/plugins\";\nimport { drizzleAdapter } from \"better-auth/adapters/drizzle\";\nimport { createAuthMiddleware } from \"better-auth/api\";\nimport { createResendAdapter } from \"@aphexcms/resend-adapter\";\nconst BETTER_AUTH_SECRET = \"your-secret-key-here-change-in-production\";\nconst BETTER_AUTH_URL = \"http://localhost:5173\";\nconst RESEND_API_KEY = \"re_your_api_key_here\";\nconst email = createResendAdapter({\n  apiKey: RESEND_API_KEY\n});\nconst emailConfig = {\n  from: \"Support @ Aphex CMS <support@newsletter.getaphex.com>\",\n  passwordReset: {\n    subject: \"Reset your password\",\n    getHtml: (userName, resetUrl) => `\n\t\t\t<h1>Password Reset</h1>\n\t\t\t<p>Hi ${userName},</p>\n\t\t\t<p>You requested to reset your password. Click the link below to reset it:</p>\n\t\t\t<p><a href=\"${resetUrl}\">Reset Password</a></p>\n\t\t\t<p>If you didn't request this, you can safely ignore this email.</p>\n\t\t\t<p>This link will expire in 1 hour.</p>\n\t\t`,\n    getText: (resetUrl) => `Reset your password by clicking this link: ${resetUrl}`\n  },\n  emailVerification: {\n    subject: \"Verify your email address\",\n    getHtml: (userName, verifyUrl) => `\n\t\t\t<h1>Email Verification</h1>\n\t\t\t<p>Hi ${userName},</p>\n\t\t\t<p>Welcome to Aphex CMS! Please verify your email address by clicking the link below:</p>\n\t\t\t<p><a href=\"${verifyUrl}\">Verify Email</a></p>\n\t\t\t<p>If you didn't create this account, you can safely ignore this email.</p>\n\t\t`,\n    getText: (verifyUrl) => `Verify your email by clicking this link: ${verifyUrl}`\n  }\n};\nlet latestPasswordResetUrl = null;\nfunction createAuthInstance(db, drizzleDb, emailAdapter) {\n  const userSyncHooks = createAuthMiddleware(async (ctx) => {\n    if (ctx.path === \"/sign-up/email\" && ctx.context.user) {\n      try {\n        await db.createUserProfile({\n          userId: ctx.context.user.id,\n          role: \"editor\"\n          // Default role\n        });\n        console.log(`[Better Auth Hook]: Created user profile for ${ctx.context.user.id}`);\n      } catch (error) {\n        console.error(\"[Better Auth Hook]: Error creating user profile:\", error);\n      }\n    }\n    if (ctx.path === \"/user/delete-user\" && ctx.context.user) {\n      console.log(`[Auth Hook]: Deletion condition met for user: ${ctx.context.user.id}`);\n      try {\n        await db.deleteUserProfile(ctx.context.user.id);\n        console.log(`[Auth Hook]: Successfully deleted user profile for ${ctx.context.user.id}`);\n      } catch (error) {\n        console.error(\"[Auth Hook]: Error deleting user profile:\", error);\n      }\n    }\n  });\n  return betterAuth({\n    baseURL: BETTER_AUTH_URL,\n    secret: BETTER_AUTH_SECRET,\n    // Better Auth's internal adapter needs the raw Drizzle client.\n    database: drizzleAdapter(drizzleDb, {\n      provider: \"pg\"\n    }),\n    emailAndPassword: {\n      enabled: true,\n      sendResetPassword: async ({ user, url, token }) => {\n        const baseUrl = BETTER_AUTH_URL;\n        const resetUrl = `${baseUrl}/reset-password/${token}`;\n        console.log(\"\\n========================================\");\n        console.log(\"ðŸ” PASSWORD RESET REQUEST\");\n        console.log(\"========================================\");\n        console.log(\"User:\", user.email);\n        console.log(\"Better Auth URL:\", url);\n        console.log(\"Constructed Reset URL:\", resetUrl);\n        console.log(\"Token:\", token);\n        console.log(\"========================================\\n\");\n        latestPasswordResetUrl = resetUrl;\n        if (emailAdapter) {\n          try {\n            const result = await emailAdapter.send({\n              from: emailConfig.from,\n              to: user.email,\n              subject: emailConfig.passwordReset.subject,\n              html: emailConfig.passwordReset.getHtml(user.name || user.email, resetUrl),\n              text: emailConfig.passwordReset.getText(resetUrl)\n            });\n            if (result.error) {\n              console.error(\"Failed to send password reset email:\", result.error);\n            } else {\n              console.log(\"Password reset email sent successfully:\", result.id);\n            }\n          } catch (error) {\n            console.error(\"Error sending password reset email:\", error);\n          }\n        } else {\n          console.warn(\"Email adapter not configured. Password reset email not sent.\");\n        }\n      }\n    },\n    emailVerification: {\n      enabled: false,\n      verifyEmailPath: \"/verify-email\",\n      // Path for email verification\n      sendVerificationEmail: async ({ user, url, token }) => {\n        console.log(\"\\n========================================\");\n        console.log(\"ðŸ“§ EMAIL VERIFICATION REQUEST\");\n        console.log(\"========================================\");\n        console.log(\"User:\", user.email);\n        console.log(\"Verification URL:\", url);\n        console.log(\"Token:\", token);\n        console.log(\"========================================\\n\");\n        if (emailAdapter) {\n          try {\n            const result = await emailAdapter.send({\n              from: emailConfig.from,\n              to: user.email,\n              subject: emailConfig.emailVerification.subject,\n              html: emailConfig.emailVerification.getHtml(user.name || user.email, url),\n              text: emailConfig.emailVerification.getText(url)\n            });\n            if (result.error) {\n              console.error(\"Failed to send verification email:\", result.error);\n            } else {\n              console.log(\"Verification email sent successfully:\", result.id);\n            }\n          } catch (error) {\n            console.error(\"Error sending verification email:\", error);\n          }\n        } else {\n          console.warn(\"Email adapter not configured. Verification email not sent.\");\n        }\n      }\n    },\n    plugins: [\n      apiKey({\n        apiKeyHeaders: [\"x-api-key\"],\n        rateLimit: {\n          enabled: true,\n          timeWindow: 1e3 * 60 * 60 * 24,\n          maxRequests: 1e4\n        },\n        enableMetadata: true\n      })\n    ],\n    hooks: {\n      after: userSyncHooks\n    }\n  });\n}\nexport {\n  createAuthInstance as c,\n  email as e,\n  latestPasswordResetUrl as l\n};\n"],"names":[],"mappings":"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"}