{"version":3,"file":"storage-_ubboXxO.js","sources":["../../../.svelte-kit/adapter-node/chunks/storage.js"],"sourcesContent":["import { stat, mkdir, writeFile, unlink, readdir } from \"fs/promises\";\nimport { join, dirname } from \"path\";\nconst DEFAULT_MAX_FILE_SIZE = 10 * 1024 * 1024;\nconst DEFAULT_ALLOWED_TYPES = [\n  \"image/jpeg\",\n  \"image/png\",\n  \"image/webp\",\n  \"image/gif\",\n  \"image/avif\",\n  \"application/pdf\",\n  \"text/plain\"\n];\nclass LocalStorageAdapter {\n  name = \"local\";\n  config;\n  constructor(config) {\n    this.config = {\n      basePath: config.basePath,\n      baseUrl: config.baseUrl || \"\",\n      maxFileSize: config.maxFileSize || DEFAULT_MAX_FILE_SIZE,\n      allowedTypes: config.allowedTypes || DEFAULT_ALLOWED_TYPES,\n      options: config.options || {}\n    };\n  }\n  /**\n   * Generate unique filename preserving original name\n   */\n  async generateUniqueFilename(originalFilename) {\n    const { name, ext } = this.parseFilename(originalFilename);\n    let filename = originalFilename;\n    let counter = 1;\n    while (await this.fileExistsOnDisk(filename)) {\n      filename = `${name} (${counter})${ext}`;\n      counter++;\n    }\n    return filename;\n  }\n  /**\n   * Parse filename into name and extension\n   */\n  parseFilename(filename) {\n    const lastDotIndex = filename.lastIndexOf(\".\");\n    if (lastDotIndex === -1) {\n      return { name: filename, ext: \"\" };\n    }\n    return {\n      name: filename.substring(0, lastDotIndex),\n      ext: filename.substring(lastDotIndex)\n    };\n  }\n  /**\n   * Check if file exists on disk\n   */\n  async fileExistsOnDisk(filename) {\n    try {\n      const filePath = join(this.config.basePath, filename);\n      await stat(filePath);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n  /**\n   * Store a file and return storage info\n   */\n  async store(data) {\n    if (!this.config.allowedTypes.includes(data.mimeType)) {\n      throw new Error(`Invalid file type: ${data.mimeType}. Allowed types: ${this.config.allowedTypes.join(\", \")}`);\n    }\n    if (data.size > this.config.maxFileSize) {\n      throw new Error(`File too large: ${data.size} bytes. Maximum size: ${this.config.maxFileSize} bytes`);\n    }\n    const filename = await this.generateUniqueFilename(data.filename);\n    const filePath = join(this.config.basePath, filename);\n    const url = \"\";\n    console.log(\"[LocalStorageAdapter] Storing file:\", {\n      filename,\n      filePath,\n      note: \"URL will be generated as /assets/{assetId}/{filename}\",\n      basePath: this.config.basePath\n    });\n    await mkdir(dirname(filePath), { recursive: true });\n    await writeFile(filePath, data.buffer);\n    return {\n      path: filePath,\n      url,\n      // Empty - API will generate clean URL with asset ID\n      size: data.size\n    };\n  }\n  /**\n   * Read a file from storage\n   * Used by API endpoint to serve files\n   */\n  async getObject(path) {\n    const { readFile } = await import(\"fs/promises\");\n    return await readFile(path);\n  }\n  /**\n   * Delete a file from storage\n   */\n  async delete(path) {\n    try {\n      await unlink(path);\n      return true;\n    } catch (error) {\n      console.warn(\"Could not delete file from disk:\", error);\n      return false;\n    }\n  }\n  /**\n   * Check if file exists\n   */\n  async exists(path) {\n    try {\n      await stat(path);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n  /**\n   * Get public URL for a file path\n   */\n  getUrl(path) {\n    const filename = path.split(\"/\").pop() || \"\";\n    return `${this.config.baseUrl}/${encodeURIComponent(filename)}`;\n  }\n  /**\n   * Get storage information\n   */\n  async getStorageInfo() {\n    try {\n      const files = await readdir(this.config.basePath);\n      let totalSize = 0;\n      for (const file of files) {\n        try {\n          const filePath = join(this.config.basePath, file);\n          const stats = await stat(filePath);\n          if (stats.isFile()) {\n            totalSize += stats.size;\n          }\n        } catch {\n        }\n      }\n      return { totalSize };\n    } catch (error) {\n      console.error(\"Error getting storage info:\", error);\n      return { totalSize: 0 };\n    }\n  }\n  /**\n   * Health check - test if we can write to storage\n   */\n  async isHealthy() {\n    try {\n      const testFile = join(this.config.basePath, `health-check-${Date.now()}.tmp`);\n      await mkdir(dirname(testFile), { recursive: true });\n      await writeFile(testFile, \"health check\");\n      await unlink(testFile);\n      return true;\n    } catch (error) {\n      console.error(\"Storage health check failed:\", error);\n      return false;\n    }\n  }\n}\nclass LocalStorageProvider {\n  name = \"local\";\n  createAdapter(config) {\n    return new LocalStorageAdapter(config);\n  }\n}\nclass StorageProviderRegistry {\n  providers = /* @__PURE__ */ new Map();\n  constructor() {\n    this.register(new LocalStorageProvider());\n  }\n  register(provider) {\n    this.providers.set(provider.name.toLowerCase(), provider);\n  }\n  get(name) {\n    return this.providers.get(name.toLowerCase());\n  }\n  list() {\n    return Array.from(this.providers.keys());\n  }\n}\nconst storageProviders = new StorageProviderRegistry();\nfunction createStorageAdapter(providerName, config) {\n  const provider = storageProviders.get(providerName);\n  if (!provider) {\n    const available = storageProviders.list();\n    throw new Error(`Unknown storage provider: ${providerName}. Available providers: ${available.join(\", \")}`);\n  }\n  return provider.createAdapter(config);\n}\nexport {\n  createStorageAdapter as c\n};\n"],"names":[],"mappings":"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"}